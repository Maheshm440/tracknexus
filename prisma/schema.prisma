generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String
  password        String?
  role            String    @default("user")
  status          String    @default("active")
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([role])
  @@index([emailVerified])
}

model EmailVerification {
  id         String    @id @default(cuid())
  email      String
  otp        String
  purpose    String    @default("signup")
  attempts   Int       @default(0)
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([email, purpose])
  @@index([expiresAt])
  @@index([createdAt])
}

model Lead {
  id            String        @id @default(cuid())
  name          String
  companyName   String
  companyEmail  String
  companySize   String
  mobileNumber  String
  message       String
  formType      String
  selectedPlan  String?
  preferredDate DateTime?
  preferredTime String?
  score         Int           @default(0)
  status        LeadStatus    @default(NEW)
  source        String?
  visitorId     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  attributions  Attribution[]
  followUps     FollowUp[]
  visitor       Visitor?      @relation(fields: [visitorId], references: [id])

  @@index([status, createdAt])
  @@index([companyEmail])
  @@index([createdAt])
}

model Visitor {
  id               String        @id @default(cuid())
  fingerprint      String?       @unique
  sessionCount     Int           @default(1)
  firstVisit       DateTime      @default(now())
  lastVisit        DateTime      @default(now())
  country          String?
  countryCode      String?
  region           String?
  city             String?
  timezone         String?
  consentGiven     Boolean       @default(false)
  consentTimestamp DateTime?
  totalPageViews   Int           @default(0)
  totalTimeOnSite  Int           @default(0)
  createdAt        DateTime      @default(now())
  attributions     Attribution[]
  leads            Lead[]
  sessions         Session[]

  @@index([lastVisit])
  @@index([country])
  @@index([createdAt])
}

model Session {
  id               String     @id @default(cuid())
  visitorId        String
  startTime        DateTime   @default(now())
  endTime          DateTime?
  duration         Int?
  referrer         String?
  utmSource        String?
  utmMedium        String?
  utmCampaign      String?
  utmTerm          String?
  utmContent       String?
  deviceType       String?
  browser          String?
  browserVersion   String?
  os               String?
  screenResolution String?
  pageViews        PageView[]
  visitor          Visitor    @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId, startTime])
  @@index([startTime])
}

model PageView {
  id          String   @id @default(cuid())
  sessionId   String
  path        String
  title       String?
  timestamp   DateTime @default(now())
  timeOnPage  Int?
  scrollDepth Int?
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([path, timestamp])
  @@index([timestamp])
}

model DailyAnalytics {
  id                 String   @id @default(cuid())
  date               DateTime @unique
  uniqueVisitors     Int      @default(0)
  totalSessions      Int      @default(0)
  totalPageViews     Int      @default(0)
  avgSessionDuration Float    @default(0)
  bounceRate         Float    @default(0)
  countryBreakdown   Json?
  topPages           Json?
  newLeads           Int      @default(0)
  conversions        Int      @default(0)
  sourceBreakdown    Json?

  @@index([date])
}

model Attribution {
  id          String   @id @default(cuid())
  leadId      String?
  visitorId   String?
  source      String?
  medium      String?
  campaign    String?
  term        String?
  content     String?
  referrer    String?
  landingPage String?
  createdAt   DateTime @default(now())
  visitor     Visitor? @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([source, medium, campaign])
  @@index([createdAt])
  @@index([leadId])
}

model BotActivity {
  id              String   @id @default(cuid())
  fingerprint     String
  ipAddress       String?
  userAgent       String
  activityType    String
  suspicionScore  Int      @default(0)
  pageViewCount   Int      @default(0)
  sessionDuration Int      @default(0)
  detectedAt      DateTime @default(now())

  @@index([activityType, detectedAt])
  @@index([fingerprint])
}

model FollowUp {
  id          String           @id @default(cuid())
  leadId      String
  title       String
  description String?
  dueDate     DateTime
  priority    FollowUpPriority @default(MEDIUM)
  status      FollowUpStatus   @default(PENDING)
  assignedTo  String?
  createdBy   String?
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  lead        Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, status])
  @@index([dueDate, status])
}

model Campaign {
  id          String         @id @default(cuid())
  name        String
  type        String
  status      CampaignStatus @default(DRAFT)
  budget      Float?
  spent       Float          @default(0)
  impressions Int            @default(0)
  clicks      Int            @default(0)
  conversions Int            @default(0)
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([status, startDate])
}

model Ticket {
  id           String           @id @default(cuid())
  ticketNumber String           @unique
  subject      String
  description  String
  email        String
  priority     TicketPriority   @default(MEDIUM)
  status       TicketStatus     @default(OPEN)
  category     String?
  assignedTo   String?
  createdBy    String?
  resolvedAt   DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  responses    TicketResponse[]

  @@index([status, priority])
  @@index([email])
  @@index([ticketNumber])
}

model TicketResponse {
  id         String   @id @default(cuid())
  ticketId   String
  message    String
  isInternal Boolean  @default(false)
  createdBy  String?
  createdAt  DateTime @default(now())
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model Client {
  id        String       @id @default(cuid())
  name      String
  email     String       @unique
  phone     String?
  company   String?
  industry  String?
  status    ClientStatus @default(ACTIVE)
  value     Float?
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([status])
  @@index([email])
}

model TeamMember {
  id         String           @id @default(cuid())
  name       String
  email      String           @unique
  role       TeamRole         @default(MEMBER)
  department String?
  phone      String?
  avatar     String?
  status     TeamMemberStatus @default(ACTIVE)
  joinedAt   DateTime         @default(now())
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([role, status])
  @@index([email])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  LOST
}

enum FollowUpPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum FollowUpStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
  CHURNED
}

enum TeamRole {
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum TeamMemberStatus {
  ACTIVE
  INACTIVE
  INVITED
}
